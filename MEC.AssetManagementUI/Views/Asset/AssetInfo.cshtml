@using MEC.AssetManagementUI.Models.AssetModel
@model AssetInfoViewModel

@{
    ViewData["Title"] = "Demirbaş Kartı";
    // Aktif zimmet var mı kontrolü (Buton davranışı için)
    bool hasActiveLoan = Model.Loans != null && Model.Loans.Any(x => x.ReturnDate == null);
}

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="bi bi-card-heading me-2"></i>Demirbaş Kartı: @Model.Name
        </h2>
        <a asp-action="Index" class="btn btn-secondary shadow-sm">
            <i class="bi bi-arrow-left"></i> Listeye Dön
        </a>
    </div>

    <ul class="nav nav-tabs mb-4" id="assetTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                <i class="bi bi-info-circle me-1"></i> Genel Bilgiler
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button">
                <i class="bi bi-images me-1"></i> Resimler
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="invoice-tab" data-bs-toggle="tab" data-bs-target="#invoice" type="button">
                <i class="bi bi-receipt me-1"></i> Fatura Bilgileri
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button">
                <i class="bi bi-person-badge me-1"></i> Zimmet Geçmişi
            </button>
        </li>
    </ul>

    <div class="tab-content" id="assetTabsContent">

        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <form asp-action="AssetInfo" asp-route-id="@Model.Id" method="post">
                        <div class="row g-4">
                            <div class="col-md-6 border-end">
                                <h6 class="text-muted mb-3 small text-uppercase fw-bold">Kimlik Bilgileri</h6>
                                <div class="mb-3">
                                    <label asp-for="Name" class="form-label fw-bold small">Demirbaş Adı</label>
                                    <input asp-for="Name" class="form-control" />
                                    <span asp-validation-for="Name" class="text-danger small"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="SerialNumber" class="form-label fw-bold small">Seri Numarası</label>
                                    <input asp-for="SerialNumber" class="form-control fw-bold" />
                                </div>
                                <div class="mb-3">
                                    <label asp-for="AssetTypeId" class="form-label fw-bold small">Türü</label>
                                    <select asp-for="AssetTypeId" class="form-select" asp-items="ViewBag.Types"></select>
                                </div>
                            </div>
                            <div class="col-md-6 ps-md-4">
                                <h6 class="text-muted mb-3 small text-uppercase fw-bold">Konum & Detay</h6>
                                <div class="mb-3">
                                    <label asp-for="SchoolId" class="form-label fw-bold small">Bulunduğu Okul</label>
                                    <select asp-for="SchoolId" class="form-select" asp-items="ViewBag.Schools"></select>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Description" class="form-label fw-bold small">Açıklama</label>
                                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-save"></i> Değişiklikleri Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="images" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Demirbaş Görselleri</h6>

                    <div>
                        <input type="file" id="imageInput" style="display: none;" accept="image/*" />
                        <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                            <i class="bi bi-upload"></i> Yeni Resim Yükle
                        </button>
                    </div>

                </div>
                <div class="card-body">
                    @if (Model.Images != null && Model.Images.Any())
                    {
                        <div class="row">
                            @foreach (var img in Model.Images)
                            {
                                <div class="col-md-3 mb-3">
                                    <div class="card h-100">
                                        <img src="@img.Url" class="card-img-top" alt="Asset Image" style="object-fit: cover; height: 150px;">
                                        <div class="card-body text-center p-2">
                                            <button class="btn btn-xs btn-danger" onclick="deleteImage(@img.Id)">
                                                <i class="bi bi-trash"></i> Sil
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-images fs-1 d-block mb-3"></i>
                            <p>Henüz yüklenmiş bir resim yok.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="invoice" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-body">
                    @if (Model.Invoice != null)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <label class="fw-bold small text-muted">Fatura No</label>
                                <p class="lead">@Model.Invoice.InvoiceNumber</p>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold small text-muted">Tedarikçi</label>
                                <p>@Model.Invoice.Supplier</p>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold small text-muted">Fatura Tarihi</label>
                                <p>@(Model.Invoice.InvoiceDate?.ToShortDateString() ?? "-")</p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i> Bu demirbaşa ait fatura bilgisi girilmemiş.
                            <button class="btn btn-sm btn-outline-warning ms-3">Fatura Ekle</button>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="loans" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Zimmet Hareketleri</h6>

                    @if (hasActiveLoan)
                    {
                        <button type="button" class="btn btn-sm btn-secondary" onclick="showActiveLoanError()">
                            <i class="bi bi-lock-fill me-1"></i> Zimmetle
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                            <i class="bi bi-box-arrow-right me-1"></i> Zimmetle
                        </button>
                    }
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0" id="loansTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Personel</th>
                                    <th>Veriliş Tarihi</th>
                                    <th>İade Tarihi</th>
                                    <th>Durum</th>
                                    <th>Notlar</th>
                                    <th style="width: 100px;">İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Loans != null && Model.Loans.Any())
                                {
                                    foreach (var loan in Model.Loans)
                                    {
                                        <tr>
                                            <td>
                                                <i class="bi bi-person-circle me-1 text-muted"></i>
                                                @(loan.AssignedTo != null ? $"{loan.AssignedTo.FirstName} {loan.AssignedTo.LastName}" : "-")
                                            </td>
                                            <td>@loan.LoanDate.ToShortDateString()</td>
                                            <td>@(loan.ReturnDate?.ToShortDateString() ?? "-")</td>
                                            <td>
                                                @if (loan.ReturnDate == null)
                                                {
                                                    <span class="badge bg-warning text-dark">Zimmetli</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">İade Alındı</span>
                                                }
                                            </td>
                                            <td>@loan.Notes</td>
                                            <td>
                                                @if (loan.ReturnDate == null)
                                                {
                                                    <button class="btn btn-sm btn-outline-success"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#returnModal"
                                                            onclick="setReturnModal(@loan.Id)">
                                                        <i class="bi bi-arrow-return-left"></i> İade
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="6" class="text-center py-4 text-muted">Kayıt Yok</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AssignAsset" method="post">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Yeni Zimmet Oluştur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="AssetId" value="@Model.Id" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Zimmetlenecek Personel</label>
                        <select name="AssignedToId" class="form-select" required asp-items="ViewBag.Employees">
                            <option value="">-- Personel Seçiniz --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Zimmet Tarihi</label>
                        <input type="date" name="LoanDate" class="form-control"
                               value="@DateTime.Now.ToString("yyyy-MM-dd")"
                               max="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Notlar</label>
                        <textarea name="Notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form asp-action="ReturnAsset" method="post">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">İade Al</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="AssetId" value="@Model.Id" />
                    <input type="hidden" name="loanId" id="returnLoanId" />

                    <div class="mb-3">
                        <label class="form-label">İade Tarihi</label>
                        <input type="date" name="returnDate" class="form-control"
                               value="@DateTime.Now.ToString("yyyy-MM-dd")"
                               max="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                    </div>
                    <p class="small text-muted">Bu işlem zimmet durumunu "İade Alındı" olarak güncelleyecektir.</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success w-100">Onayla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section Scripts {
    <script>
        // ----------------------------------------------------
        // 1. RESİM YÜKLEME (API İsteği + DB Kaydı)
        // ----------------------------------------------------
        document.getElementById('imageInput').addEventListener('change', function () {
            var file = this.files[0];
            if (!file) return;

            // Asset ID'yi alıyoruz
            var assetId = '@Model.Id';

            var formData = new FormData();
            formData.append('File', file);       // API'deki IFormFile File
            formData.append('AssetId', assetId); // API'deki int AssetId

            Swal.fire({
                title: 'Yükleniyor...',
                text: 'Resim sunucuya yükleniyor, lütfen bekleyin.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            // LÜTFEN PORT NUMARASINI KONTROL EDİN (Örn: 7152)
            var apiUrl = 'https://localhost:7103/api/Image/Upload';

            $.ajax({
                url: apiUrl,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        // Başarılı olursa Veritabanına kaydet
                        // Gelen dosya adı: "isim_id.uzanti" formatındadır.
                        saveImageToDb(response.fileName);
                    } else {
                        Swal.fire('Hata', 'Yükleme başarısız: ' + response.message, 'error');
                    }
                },
                error: function (xhr) {
                    Swal.fire('Hata', 'API ile iletişim kurulamadı. Port ve CORS ayarlarını kontrol edin.', 'error');
                }
            });
        });

        // Veritabanı Kayıt Fonksiyonu
        function saveImageToDb(fileName) {
            var assetId = '@Model.Id';
            $.post('/Asset/AddImage', { assetId: assetId, fileName: fileName }, function (res) {
                if (res.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı',
                        text: 'Resim başarıyla eklendi!',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Hata', 'Veritabanına kayıt yapılamadı.', 'error');
                }
            });
        }

        // ----------------------------------------------------
        // 2. RESİM SİLME (Onaylı)
        // ----------------------------------------------------
        function deleteImage(id) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu resmi silmek istediğinize emin misiniz?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, Sil!',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {

                    // AssetController > DeleteImage aksiyonuna istek atıyoruz
                    $.post('/Asset/DeleteImage', { id: id }, function (response) {
                        if (response.success) {
                            Swal.fire(
                                'Silindi!',
                                'Resim başarıyla silindi.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Hata', 'Silme işlemi başarısız: ' + (response.message || ''), 'error');
                        }
                    }).fail(function() {
                        Swal.fire('Hata', 'Sunucu ile iletişim kurulamadı.', 'error');
                    });
                }
            });
        }

        // ----------------------------------------------------
        // 3. YARDIMCI FONKSİYONLAR
        // ----------------------------------------------------
        function setReturnModal(loanId) {
            document.getElementById('returnLoanId').value = loanId;
        }

        function showActiveLoanError() {
            Swal.fire({
                icon: 'warning',
                title: 'İşlem Engellendi',
                text: 'Bu demirbaş üzerinde zaten aktif bir zimmet bulunuyor.',
                confirmButtonText: 'Tamam'
            });
        }

        // Sayfa yüklendiğinde yapılacaklar
        document.addEventListener("DOMContentLoaded", function () {
            // Hangi sekme aktif olacak?
            var activeTab = '@TempData["ActiveTab"]';
            if (activeTab === 'loans') {
                var triggerEl = document.querySelector('#loans-tab');
                var tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }

            // Bildirim mesajları
            var successMsg = '@TempData["Success"]';
            if (successMsg) {
                Swal.fire({ icon: 'success', title: 'Başarılı!', text: successMsg, timer: 2000, showConfirmButton: false });
            }

            var errorMsg = '@TempData["Error"]';
            if (errorMsg) {
                Swal.fire({ icon: 'error', title: 'Hata!', text: errorMsg });
            }
        });
    </script>
}