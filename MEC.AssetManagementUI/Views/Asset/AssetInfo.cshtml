@using MEC.AssetManagementUI.Models.AssetModel
@model AssetInfoViewModel

@{
    ViewData["Title"] = "Demirbaş Kartı";

    // Aktif zimmet var mı kontrolü (Buton davranışı için)
    bool hasActiveLoan = Model.Loans != null && Model.Loans.Any(x => x.ReturnDate == null);
}

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="bi bi-card-heading me-2"></i>Demirbaş Kartı: @Model.Name
        </h2>
        <a asp-action="Index" class="btn btn-secondary shadow-sm">
            <i class="bi bi-arrow-left"></i> Listeye Dön
        </a>
    </div>

    <ul class="nav nav-tabs mb-4" id="assetTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                <i class="bi bi-info-circle me-1"></i> Genel Bilgiler
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button">
                <i class="bi bi-images me-1"></i> Resimler
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="invoice-tab" data-bs-toggle="tab" data-bs-target="#invoice" type="button">
                <i class="bi bi-receipt me-1"></i> Fatura Bilgileri
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button">
                <i class="bi bi-person-badge me-1"></i> Zimmet Geçmişi
            </button>
        </li>
    </ul>

    <div class="tab-content" id="assetTabsContent">

        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <form asp-action="AssetInfo" asp-route-id="@Model.Id" method="post">
                        <div class="row g-4">
                            <div class="col-md-6 border-end">
                                <h6 class="text-muted mb-3 small text-uppercase fw-bold">Kimlik Bilgileri</h6>
                                <div class="mb-3">
                                    <label asp-for="Name" class="form-label fw-bold small">Demirbaş Adı</label>
                                    <input asp-for="Name" class="form-control" />
                                    <span asp-validation-for="Name" class="text-danger small"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="SerialNumber" class="form-label fw-bold small">Seri Numarası</label>
                                    <input asp-for="SerialNumber" class="form-control fw-bold" />
                                </div>
                                <div class="mb-3">
                                    <label asp-for="AssetTypeId" class="form-label fw-bold small">Türü</label>
                                    <select asp-for="AssetTypeId" class="form-select" asp-items="ViewBag.Types"></select>
                                </div>
                            </div>
                            <div class="col-md-6 ps-md-4">
                                <h6 class="text-muted mb-3 small text-uppercase fw-bold">Konum & Detay</h6>
                                <div class="mb-3">
                                    <label asp-for="SchoolId" class="form-label fw-bold small">Bulunduğu Okul</label>
                                    <select asp-for="SchoolId" class="form-select" asp-items="ViewBag.Schools"></select>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Description" class="form-label fw-bold small">Açıklama</label>
                                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-save"></i> Değişiklikleri Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="images" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Demirbaş Görselleri</h6>
                    <button class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-upload"></i> Yeni Resim Yükle
                    </button>
                </div>
                <div class="card-body">
                    @if (Model.Images != null && Model.Images.Any())
                    {
                        <div class="row">
                            @foreach (var img in Model.Images)
                            {
                                <div class="col-md-3 mb-3">
                                    <div class="card h-100">
                                        <img src="@img.Url" class="card-img-top" alt="Asset Image" style="object-fit: cover; height: 150px;">
                                        <div class="card-body text-center p-2">
                                            <button class="btn btn-xs btn-danger"><i class="bi bi-trash"></i> Sil</button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-images fs-1 d-block mb-3"></i>
                            <p>Henüz yüklenmiş bir resim yok.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="invoice" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-body">

                    @if (Model.Invoice != null)
                    {
                        <div class="row mb-4">
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-4">
                            <i class="bi bi-exclamation-triangle me-2"></i> Bu demirbaşa ait fatura bilgisi girilmemiş.
                        </div>
                    }

                    <div class="border-top pt-3">
                        <h6 class="fw-bold text-gray-800 mb-3"><i class="bi bi-file-earmark-pdf me-2"></i>Fatura Belgesi Yükle</h6>
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label small text-muted">PDF Dosyası Seçin</label>
                                <input type="file" id="invoicePdfInput" class="form-control" accept=".pdf" />
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-primary w-100" onclick="uploadInvoicePdf()">
                                    <i class="bi bi-cloud-upload me-2"></i> Sisteme Yükle
                                </button>
                            </div>
                        </div>
                        <div id="uploadStatus" class="mt-2 small"></div>
                    </div>

                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="loans" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Zimmet Hareketleri</h6>

                    @if (hasActiveLoan)
                    {
                        <button type="button" class="btn btn-sm btn-secondary" onclick="showActiveLoanError()">
                            <i class="bi bi-lock-fill me-1"></i> Zimmetle
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                            <i class="bi bi-box-arrow-right me-1"></i> Zimmetle
                        </button>
                    }
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0" id="loansTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Personel</th>
                                    <th>Veriliş Tarihi</th>
                                    <th>İade Tarihi</th>
                                    <th>Durum</th>
                                    <th>Notlar</th>
                                    <th style="width: 100px;">İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Loans != null && Model.Loans.Any())
                                {
                                    foreach (var loan in Model.Loans)
                                    {
                                        <tr>
                                            <td>
                                                <i class="bi bi-person-circle me-1 text-muted"></i>
                                                @(loan.AssignedTo != null ? $"{loan.AssignedTo.FirstName} {loan.AssignedTo.LastName}" : "-")
                                            </td>
                                            <td>@loan.LoanDate.ToShortDateString()</td>
                                            <td>@(loan.ReturnDate?.ToShortDateString() ?? "-")</td>
                                            <td>
                                                @if (loan.ReturnDate == null)
                                                {
                                                    <span class="badge bg-warning text-dark">Zimmetli</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">İade Alındı</span>
                                                }
                                            </td>
                                            <td>@loan.Notes</td>
                                            <td>
                                                @if (loan.ReturnDate == null)
                                                {
                                                    <button class="btn btn-sm btn-outline-success"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#returnModal"
                                                            onclick="setReturnModal(@loan.Id)">
                                                        <i class="bi bi-arrow-return-left"></i> İade
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="6" class="text-center py-4 text-muted">Kayıt Yok</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AssignAsset" method="post">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Yeni Zimmet Oluştur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="AssetId" value="@Model.Id" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Zimmetlenecek Personel</label>
                        <select name="AssignedToId" class="form-select" required asp-items="ViewBag.Employees">
                            <option value="">-- Personel Seçiniz --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Zimmet Tarihi</label>
                        <input type="date" name="LoanDate" class="form-control"
                               value="@DateTime.Now.ToString("yyyy-MM-dd")"
                               max="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Notlar</label>
                        <textarea name="Notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form asp-action="ReturnAsset" method="post">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">İade Al</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="AssetId" value="@Model.Id" />
                    <input type="hidden" name="loanId" id="returnLoanId" />

                    <div class="mb-3">
                        <label class="form-label">İade Tarihi</label>
                        <input type="date" name="returnDate" class="form-control"
                               value="@DateTime.Now.ToString("yyyy-MM-dd")"
                               max="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                    </div>
                    <p class="small text-muted">Bu işlem zimmet durumunu "İade Alındı" olarak güncelleyecektir.</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success w-100">Onayla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // 1. İade Modalına ID Taşıma
    function setReturnModal(loanId) {
        document.getElementById('returnLoanId').value = loanId;
    }

    // 2. Aktif Zimmet Uyarısı (Butona basılınca)
    function showActiveLoanError() {
        Swal.fire({
            icon: 'warning',
            title: 'İşlem Engellendi',
            text: 'Bu demirbaş üzerinde zaten aktif bir zimmet bulunuyor. Yeni zimmet yapabilmek için önce mevcut zimmeti iade almalısınız.',
            confirmButtonText: 'Tamam'
        });
    }

    // 3. Sayfa Yüklendiğinde Çalışacak Kodlar
    document.addEventListener("DOMContentLoaded", function () {

        // A) Hangi Sekme Açılacak? (Controller'dan gelen TempData)
        var activeTab = '@TempData["ActiveTab"]';
        if (activeTab === 'loans') {
            // Bootstrap 5 ile sekmeyi açma
            var triggerEl = document.querySelector('#loans-tab');
            var tab = new bootstrap.Tab(triggerEl);
            tab.show();
        }

        // B) Başarı Mesajı Var mı?
        var successMsg = '@TempData["Success"]';
        if (successMsg) {
            Swal.fire({
                icon: 'success',
                title: 'Başarılı!',
                text: successMsg,
                timer: 2000,
                showConfirmButton: false
            });
        }

        // C) Hata Mesajı Var mı?
        var errorMsg = '@TempData["Error"]';
        if (errorMsg) {
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: errorMsg
            });
        }
    });

    // Fatura Yükleme Fonksiyonu
    async function uploadInvoicePdf() {
        const fileInput = document.getElementById('invoicePdfInput');
        const file = fileInput.files[0];
        const assetId = '@Model.Id'; // Razor modelden ID'yi alıyoruz
        const statusDiv = document.getElementById('uploadStatus');

        if (!file) {
            Swal.fire({
                icon: 'warning',
                title: 'Dosya Seçilmedi',
                text: 'Lütfen yüklemek için bir PDF dosyası seçiniz.'
            });
            return;
        }

        // Form verisi hazırlama
        const formData = new FormData();
        formData.append('file', file);
        formData.append('assetId', assetId);

        // Yükleniyor mesajı
        statusDiv.innerHTML = '<span class="text-info"><i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i> Yükleniyor...</span>';

        try {
            // NOT: Port numarasını WebAPI projenizin launchSettings.json dosyasındaki https portuna göre güncelleyin (örn: 7103)
            const response = await fetch('https://localhost:7103/api/Attachment/UploadAttachment', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                statusDiv.innerHTML = '<span class="text-success fw-bold"><i class="bi bi-check-circle"></i> Dosya başarıyla yüklendi!</span>';

                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı',
                    text: 'Fatura belgesi başarıyla yüklendi.',
                    timer: 2000
                });

                // İsteğe bağlı: Input'u temizle
                fileInput.value = '';
            } else {
                const errorText = await response.text();
                statusDiv.innerHTML = '<span class="text-danger">Hata oluştu.</span>';
                Swal.fire('Hata', errorText || 'Yükleme başarısız.', 'error');
            }
        } catch (error) {
            console.error('Upload Error:', error);
            statusDiv.innerHTML = '<span class="text-danger">Bağlantı hatası.</span>';
            Swal.fire('Hata', 'API sunucusuna erişilemedi. WebAPI projesinin çalıştığından emin olun.', 'error');
        }
    }
</script>