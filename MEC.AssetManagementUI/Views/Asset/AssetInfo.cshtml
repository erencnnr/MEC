@using MEC.AssetManagementUI.Models.AssetModel
@model AssetInfoViewModel

@{
    ViewData["Title"] = "Demirbaş Kartı";
    bool hasActiveLoan = Model.Loans != null && Model.Loans.Any(x => x.ReturnDate == null);
}

<style>
    /* Resim galerisi stilleri */
    .img-wrapper {
        position: relative;
        cursor: pointer;
        overflow: hidden;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        transition: transform 0.2s;
    }

        .img-wrapper:hover {
            transform: scale(1.02);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
        }

    .download-btn-overlay {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background-color: rgba(255, 255, 255, 0.9);
        color: #333;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s;
        z-index: 10;
        text-decoration: none;
    }

        .download-btn-overlay:hover {
            background-color: #0d6efd;
            color: white;
            transform: scale(1.1);
        }

    .delete-btn-overlay {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: rgba(220, 53, 69, 0.9);
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s;
        z-index: 20;
        text-decoration: none;
    }

        .delete-btn-overlay:hover {
            background-color: #bb2d3b;
            color: white;
            transform: scale(1.1);
        }

    /* Doküman Listesi İmleci */
    .attachment-link {
        cursor: pointer;
        color: #0d6efd;
        text-decoration: none;
        font-weight: 500;
    }

        .attachment-link:hover {
            text-decoration: underline;
            color: #0a58ca;
        }
</style>

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="bi bi-card-heading me-2"></i>Demirbaş Kartı: @Model.Name
        </h2>
        <a asp-action="Index" class="btn btn-secondary shadow-sm">
            <i class="bi bi-arrow-left"></i> Listeye Dön
        </a>
    </div>

    <ul class="nav nav-tabs mb-4" id="assetTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active fw-bold" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">
                <i class="bi bi-info-circle me-1"></i> Genel Bilgiler
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" onclick="loadAssetImages()">
                <i class="bi bi-images me-1"></i> Resimler
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments" type="button" onclick="loadAttachments()">
                <i class="bi bi-paperclip me-1"></i> Dokümanlar
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button">
                <i class="bi bi-person-badge me-1"></i> Zimmet Geçmişi
            </button>
        </li>
    </ul>

    <div class="tab-content" id="assetTabsContent">

        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <form asp-action="AssetInfo" asp-route-id="@Model.Id" method="post">
                        <div class="row g-4">
                            <div class="col-md-6 border-end">
                                <div class="mb-3">
                                    <label asp-for="Name" class="form-label fw-bold small">Demirbaş Adı</label>
                                    <input asp-for="Name" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label asp-for="SerialNumber" class="form-label fw-bold small">Seri Numarası</label>
                                    <input asp-for="SerialNumber" class="form-control fw-bold" />
                                </div>
                                <div class="mb-3">
                                    <label asp-for="AssetTypeId" class="form-label fw-bold small">Türü</label>
                                    <select asp-for="AssetTypeId" class="form-select" asp-items="ViewBag.Types"></select>
                                </div>
                            </div>
                            <div class="col-md-6 ps-md-4">
                                <div class="mb-3">
                                    <label asp-for="SchoolId" class="form-label fw-bold small">Bulunduğu Okul</label>
                                    <select asp-for="SchoolId" class="form-select" asp-items="ViewBag.Schools" id="SchoolDropdown"></select>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="SchoolClassId" class="form-label fw-bold small">Sınıf / Şube</label>
                                    <select asp-for="SchoolClassId" class="form-select" id="ClassDropdown" disabled></select>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="WarrantyEndDate" class="form-label fw-bold small">Garanti Bitiş</label>
                                            <input asp-for="WarrantyEndDate" class="form-control" type="date" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="InvoiceDate" class="form-label fw-bold small">Fatura Tarihi</label>
                                            <input asp-for="InvoiceDate" class="form-control" type="date" />
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Description" class="form-label fw-bold small">Açıklama</label>
                                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-primary px-4"><i class="bi bi-save"></i> Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="images" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Demirbaş Görselleri</h6>
                    <div>
                        <input type="file" id="imageInput" style="display: none;" accept="image/*" />
                        <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                            <i class="bi bi-upload"></i> Yeni Resim Yükle
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="imageGalleryContainer" class="row">
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="attachments" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Bağlı Dokümanlar & Ekler</h6>
                </div>
                <div class="card-body">

                    <div class="bg-light p-3 rounded border mb-4">
                        <div class="row align-items-end">
                            <div class="col-md-9">
                                <label class="form-label small fw-bold text-muted">Dosya Seç (PDF, Word, Excel vb.)</label>
                                <input type="file" id="attachmentInput" class="form-control" />
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-primary w-100" onclick="uploadAttachment()">
                                    <i class="bi bi-cloud-upload me-2"></i> Yükle
                                </button>
                            </div>
                        </div>
                        <div id="attachmentUploadStatus" class="mt-2 small"></div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Dosya Adı</th>
                                    <th class="text-end" style="width: 150px;">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="attachmentTableBody">
                                <tr><td colspan="3" class="text-center text-muted">Yükleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="loans" role="tabpanel">
            <div class="card shadow mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Zimmet Hareketleri</h6>
                    @if (hasActiveLoan)
                    {
                        <button type="button" class="btn btn-sm btn-secondary" onclick="showActiveLoanError()">
                            <i class="bi bi-lock-fill me-1"></i> Zimmetle
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                            <i class="bi bi-box-arrow-right me-1"></i> Zimmetle
                        </button>
                    }
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Personel</th>
                                    <th>Veriliş</th>
                                    <th>İade</th>
                                    <th>Durum</th>
                                    <th>Notlar</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Loans != null && Model.Loans.Any())
                                {
                                    foreach (var loan in Model.Loans)
                                    {
                                        <tr>
                                            <td>@(loan.AssignedTo != null ? $"{loan.AssignedTo.FirstName} {loan.AssignedTo.LastName}" : "-")</td>
                                            <td>@loan.LoanDate.ToShortDateString()</td>
                                            <td>@(loan.ReturnDate?.ToShortDateString() ?? "-")</td>
                                            <td>
                                                @if (loan.ReturnDate == null)
                                                {
                                                    <span class="badge bg-warning text-dark">Zimmetli</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">İade Alındı</span>
                                                }
                                            </td>
                                            <td>@loan.Notes</td>
                                            <td>
                                                @if (loan.ReturnDate == null)
                                                {
                                                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#returnModal" onclick="setReturnModal(@loan.Id)">İade</button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="6" class="text-center py-4 text-muted">Kayıt Yok</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 position-relative text-center">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                <img id="modalFullImage" src="" class="img-fluid rounded shadow-lg" style="max-height: 85vh;">
                <div class="mt-3"><a id="modalDownloadBtn" href="#" class="btn btn-primary" download>İndir</a></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AssignAsset" method="post">
                <div class="modal-header"><h5 class="modal-title">Zimmetle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" name="AssetId" value="@Model.Id" />
                    <div class="mb-3">
                        <label>Personel</label>
                        <select name="AssignedToId" class="form-select" required asp-items="ViewBag.Employees"><option value="">Seçiniz</option></select>
                    </div>
                    <div class="mb-3"><label>Tarih</label><input type="date" name="LoanDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" required /></div>
                    <div class="mb-3"><label>Not</label><textarea name="Notes" class="form-control"></textarea></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Kaydet</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form asp-action="ReturnAsset" method="post">
                <div class="modal-header"><h5 class="modal-title">İade Al</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" name="AssetId" value="@Model.Id" />
                    <input type="hidden" name="loanId" id="returnLoanId" />
                    <div class="mb-3"><label>Tarih</label><input type="date" name="returnDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" required /></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-success w-100">Onayla</button></div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section Scripts {
    <script>
        // --- ORTAK DEĞİŞKENLER ---
        var assetId = '@Model.Id';

        $(document).ready(function () {
            // Dropdown Mantığı (Aynı kalıyor)
            // ... (Dropdown kodları burada varsayılıyor, önceki kodunuzdan alabilirsiniz) ...

            // Açılışta hangi tab aktifse onu yükle
            if ($('#images-tab').hasClass('active')) loadAssetImages();
            if ($('#attachments-tab').hasClass('active')) loadAttachments();
        });

        // ----------------------------------------------------
        // --- BÖLÜM 1: DOKÜMAN / EK YÖNETİMİ (Attachment) ---
        // ----------------------------------------------------

        // 1.1 Yükleme
        async function uploadAttachment() {
            const fileInput = document.getElementById('attachmentInput');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('attachmentUploadStatus');

            if (!file) {
                Swal.fire({ icon: 'warning', title: 'Dosya Seçilmedi', text: 'Lütfen yüklenecek bir dosya seçiniz.' });
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('assetId', assetId);

            statusDiv.innerHTML = '<span class="text-info"><i class="spinner-border spinner-border-sm"></i> Yükleniyor...</span>';

            // API'ye Yükle
            try {
                const apiResponse = await fetch('http://192.168.1.12:5051/api/Attachment/UploadAttachment', {
                    method: 'POST',
                    body: formData
                });

                if (apiResponse.ok) {
                    const result = await apiResponse.json();

                    // Başarılı ise DB'ye Kaydet (MVC)
                    $.post('/Asset/AddAttachment', { assetId: assetId, fileName: result.fileName }, function (dbRes) {
                        if (dbRes.success) {
                            statusDiv.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Yüklendi.</span>';
                            fileInput.value = ''; // Inputu temizle
                            Swal.fire({ icon: 'success', title: 'Başarılı', text: 'Doküman yüklendi.', timer: 1500, showConfirmButton: false });
                            loadAttachments(); // Listeyi yenile
                        } else {
                            statusDiv.innerHTML = '<span class="text-warning">Dosya yüklendi fakat veritabanı kaydı başarısız.</span>';
                        }
                    });

                } else {
                    const errorText = await apiResponse.text();
                    statusDiv.innerHTML = '<span class="text-danger">Yükleme başarısız.</span>';
                    Swal.fire('Hata', errorText || 'API hatası.', 'error');
                }
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = '<span class="text-danger">Bağlantı hatası.</span>';
            }
        }

        // 1.2 Listeleme
        function loadAttachments() {
            const tableBody = $('#attachmentTableBody');
            tableBody.html('<tr><td colspan="3" class="text-center"><div class="spinner-border text-primary spinner-border-sm"></div> Yükleniyor...</td></tr>');

            $.ajax({
                url: 'http://192.168.1.12:5051/api/Attachment/GetAttachmentList?assetId=' + assetId,
                type: 'GET',
                success: function (response) {
                    if (response.success && response.files && response.files.length > 0) {
                        let html = '';
                        $.each(response.files, function (index, fileName) {
                            // İndirme URL'si
                            let downloadUrl = `http://192.168.1.12:5051/api/Attachment/GetAttachment?assetId=${assetId}&fileName=${fileName}`;

                            html += `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>
                                                <span class="attachment-link" onclick="forceDownload('${downloadUrl}')">
                                                    <i class="bi bi-file-earmark-text me-2"></i>${fileName}
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="forceDownload('${downloadUrl}')" title="İndir">
                                                    <i class="bi bi-download"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment('${fileName}')" title="Sil">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                        });
                        tableBody.html(html);
                    } else {
                        tableBody.html('<tr><td colspan="3" class="text-center text-muted">Henüz dosya yüklenmemiş.</td></tr>');
                    }
                },
                error: function () {
                    tableBody.html('<tr><td colspan="3" class="text-center text-danger">Liste yüklenirken hata oluştu.</td></tr>');
                }
            });
        }

        // 1.3 Silme
        function deleteAttachment(fileName) {
            Swal.fire({
                title: 'Silinsin mi?',
                text: "Bu dosya kalıcı olarak silinecek.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Evet, Sil'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Önce DB'den sil
                    $.post('/Asset/DeleteAttachment', { assetId: assetId, fileName: fileName }, function (dbRes) {
                        if (dbRes.success) {
                            // Sonra Diskten Sil (API)
                            $.ajax({
                                url: `http://192.168.1.12:5051/api/Attachment/DeleteAttachment?assetId=${assetId}&fileName=${encodeURIComponent(fileName)}`,
                                type: 'DELETE',
                                crossDomain: true,
                                success: function () {
                                    Swal.fire({ icon: 'success', title: 'Silindi', timer: 1500, showConfirmButton: false });
                                    loadAttachments();
                                },
                                error: function (xhr) {
                                    Swal.fire({ icon: 'warning', title: 'Kısmen Silindi', text: 'DB kaydı silindi ama diskten silinemedi.' });
                                    loadAttachments();
                                }
                            });
                        } else {
                            Swal.fire('Hata', dbRes.message, 'error');
                        }
                    });
                }
            });
        }

        // ----------------------------------------------
        // --- BÖLÜM 2: RESİM YÜKLEME / LİSTELEME ---
        // ----------------------------------------------
        // (Bu kısımlar önceki çalışan kodunuzun aynısıdır)

        function loadAssetImages() {
            var apiUrl = 'http://192.168.1.12:5051/api/Image/GetImageList?assetId=' + assetId;
            var container = $('#imageGalleryContainer');
            container.html('<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>');

            $.ajax({
                url: apiUrl, type: 'GET',
                success: function (response) {
                    if (response.success && response.files && response.files.length > 0) {
                        var html = '';
                        $.each(response.files, function (index, fileName) {
                            var imgUrl = 'http://192.168.1.12:5051/api/Image/GetImage/' + assetId + '/' + fileName;
                            html += `
                                         <div class="col-md-3 mb-3">
                                             <div class="img-wrapper" onclick="showImageModal('${imgUrl}')">
                                                 <div style="height: 180px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                                     <img src="${imgUrl}" class="img-fluid" style="max-height: 100%; max-width: 100%;">
                                                 </div>
                                                 <a href="javascript:void(0);" class="download-btn-overlay" onclick="event.stopPropagation(); forceDownload('${imgUrl}')"><i class="bi bi-download small"></i></a>
                                                 <a href="javascript:void(0);" class="delete-btn-overlay" onclick="event.stopPropagation(); deleteAssetImage('${fileName}')"><i class="bi bi-trash-fill small"></i></a>
                                             </div>
                                         </div>`;
                        });
                        container.html(html);
                    } else { container.html('<div class="col-12 text-center py-5 text-muted"><p>Resim yok.</p></div>'); }
                },
                error: function () { container.html('<div class="text-center py-5 text-muted"><p>Resim yok.</p></div>'); }
            });
        }

        function showImageModal(url) {
            $('#modalFullImage').attr('src', url);
            $('#modalDownloadBtn').off('click').on('click', function (e) { e.preventDefault(); forceDownload(url); });
            new bootstrap.Modal(document.getElementById('imageViewerModal')).show();
        }

        document.getElementById('imageInput').addEventListener('change', function () {
            var file = this.files[0];
            if (!file) return;
            var formData = new FormData();
            formData.append('File', file);
            formData.append('AssetId', assetId);
            Swal.fire({ title: 'Yükleniyor...', didOpen: () => { Swal.showLoading() } });

            $.ajax({
                url: 'http://192.168.1.12:5051/api/Image/Upload', type: 'POST', data: formData, processData: false, contentType: false,
                success: function (res) {
                    if (res.success) {
                        $.post('/Asset/AddImage', { assetId: assetId, fileName: res.fileName }, function (dbRes) {
                            if (dbRes.success) { Swal.fire({ icon: 'success', title: 'Yüklendi', timer: 1500, showConfirmButton: false }); loadAssetImages(); }
                        });
                    }
                },
                error: function () { Swal.fire('Hata', 'API Hatası', 'error'); }
            });
        });

        function deleteAssetImage(fileName) {
            Swal.fire({ title: 'Silinsin mi?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sil' }).then((r) => {
                if (r.isConfirmed) {
                    $.post('/Asset/DeleteImage', { assetId: assetId, fileName: fileName }, function (res) {
                        if (res.success) {
                            $.ajax({
                                url: `http://192.168.1.12:5051/api/Image/DeleteImage?assetId=${assetId}&fileName=${encodeURIComponent(fileName)}`,
                                type: 'DELETE', crossDomain: true,
                                success: function () { Swal.fire('Silindi', '', 'success'); loadAssetImages(); },
                                error: function (xhr) { Swal.fire('Hata', 'Disk silme hatası: ' + xhr.status, 'warning'); loadAssetImages(); }
                            });
                        }
                    });
                }
            });
        }

        // --- ORTAK İNDİRME FONKSİYONU ---
        function forceDownload(url) {
            var filename = url.substring(url.lastIndexOf('/') + 1);
            filename = decodeURIComponent(filename);
            Swal.fire({ title: 'İndiriliyor...', timer: 1000, showConfirmButton: false, didOpen: () => { Swal.showLoading() } });
            fetch(url).then(r => r.blob()).then(blob => {
                var u = window.URL.createObjectURL(blob);
                var a = document.createElement('a'); a.href = u; a.download = filename;
                document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(u);
            }).catch(e => Swal.fire('Hata', 'İndirilemedi', 'error'));
        }

        // --- DİĞER FONKSİYONLAR (Zimmet, Dropdown vs.) ---
        function setReturnModal(id) { document.getElementById('returnLoanId').value = id; }
    </script>
}